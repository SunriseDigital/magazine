#!/bin/bash
#
#/path/to/initapp /path/to/target_dir /path/to/context_dir

### オプション解析
# -f シンボリックリンクを強制的に作る
while getopts f OPT
do
	case $OPT in
		"f" ) force_symlink="TRUE" ;;
	esac
done

### ディレクトリ名を取得
script_dir=`dirname $0`

#共通関数をinclude
sdx_dir="/home/source/sites/sdx"
. ${sdx_dir}/bin/func

### 引数チェック
#target_dir
if [ -n "$1" ]
then
	target_dir=$1

	first_chr=`echo ${target_dir} | cut -c 1`
	if [ "$first_chr" != / ]
	then
		echo Use full path start from "/" for target_dir
		exit
	fi

	target_name=`echo ${target_dir} | sed -e "s/.*\/\([^/]*\)\$/\1/g"`

else
	echo Please enter /path/to/target_dir.
	exit
fi

#context_dir
if [ -n "$2" ]
then
	context_dir=$2

	first_chr=`echo ${context_dir} | cut -c 1`
	if [ "$first_chr" != / ]
	then
		echo Use full path start from "/" for context_dir
		exit
	fi

	app_name=`echo ${context_dir} | sed -e "s/.*\/\([^/]*\)\$/\1/g"`

else
	echo Please enter /path/to/context_dir.
	exit
fi

### ディレクトリ作成
mkdirs=(\
	${target_dir}/css \
	${target_dir}/css/i18n \
	${target_dir}/img \
	${target_dir}/img/i18n \
	${target_dir}/js \
	${target_dir}/js/i18n \
	${context_dir}/app \
	${context_dir}/app/views \
	${context_dir}/app/views/default \
	${context_dir}/app/views/default/error \
	${context_dir}/app/views/default/index \
	${context_dir}/app/views/default/magazine \
	${context_dir}/app/views/i18n \
	${context_dir}/app/views/mobile \
	${context_dir}/app/views/mobile/error \
	${context_dir}/app/views/mobile/index \
	${context_dir}/app/views/mobile/magazine \
	${context_dir}/cache \
	${context_dir}/config \
	${context_dir}/config/i18n \
	${context_dir}/config/magazine \
	${context_dir}/i18n \
	${context_dir}/log \
	${context_dir}/logs \
	${context_dir}/tmp \
	${context_dir}/tmp/templates_c
)

### 作成実行
mkdirFromArray

### 書き込みディレクトリのパーミッション変更
chmod 0777 ${context_dir}/cache
chmod 0777 ${context_dir}/log
chmod 0777 ${context_dir}/logs
chmod 0777 ${context_dir}/tmp
chmod 0777 ${context_dir}/tmp/templates_c

### ファイルをコピー
cp_from=(\
	${script_dir}/copy/config/magazine/category.yml \
	${script_dir}/copy/config/magazine/group.yml \
	${script_dir}/copy/config/magazine/list.yml \
	${script_dir}/copy/config/Configuration.php \
	${script_dir}/copy/config/mobile_route.yml \
	${script_dir}/copy/config/route.yml \
	${script_dir}/copy/config/sys.yml \
	${script_dir}/copy/views/default/error/404.tpl \
	${script_dir}/copy/views/default/error/500.tpl \
	${script_dir}/copy/views/default/index/index.tpl \
	${script_dir}/copy/views/default/magazine/article/1/body.tpl \
	${script_dir}/copy/views/default/magazine/article/1/outline.tpl \
	${script_dir}/copy/views/default/magazine/article.tpl \
	${script_dir}/copy/views/default/magazine/base.tpl \
	${script_dir}/copy/views/default/magazine/category.tpl \
	${script_dir}/copy/views/default/magazine/group.tpl \
	${script_dir}/copy/views/default/magazine/index.tpl \
	${script_dir}/copy/views/mobile/error/404.tpl \
	${script_dir}/copy/views/mobile/error/500.tpl \
	${script_dir}/copy/views/mobile/index/index.tpl \
	${script_dir}/copy/views/mobile/magazine/article.tpl \
	${script_dir}/copy/views/mobile/magazine/base.tpl \
	${script_dir}/copy/views/mobile/magazine/category.tpl \
	${script_dir}/copy/views/mobile/magazine/group.tpl \
	${script_dir}/copy/views/mobile/magazine/index.tpl \
	${script_dir}/copy/web/htaccess \
	${script_dir}/copy/gitignore
)

cp_to=(\
	${context_dir}/config/magazine/category.yml \
	${context_dir}/config/magazine/group.yml \
	${context_dir}/config/magazine/list.yml \
	${context_dir}/config/Configuration.php \
	${context_dir}/config/mobile_route.yml \
	${context_dir}/config/route.yml \
	${context_dir}/config/sys.yml \
	${context_dir}/app/views/default/error/404.tpl \
	${context_dir}/app/views/default/error/500.tpl \
	${context_dir}/app/views/default/index/index.tpl \
	${context_dir}/app/views/default/magazine/article/1/body.tpl \
	${context_dir}/app/views/default/magazine/article/1/outline.tpl \
	${context_dir}/app/views/default/magazine/article.tpl \
	${context_dir}/app/views/default/magazine/base.tpl \
	${context_dir}/app/views/default/magazine/category.tpl \
	${context_dir}/app/views/default/magazine/group.tpl \
	${context_dir}/app/views/default/magazine/index.tpl \
	${context_dir}/app/views/mobile/error/404.tpl \
	${context_dir}/app/views/mobile/error/500.tpl \
	${context_dir}/app/views/mobile/index/index.tpl \
	${context_dir}/app/views/mobile/magazine/article.tpl \
	${context_dir}/app/views/mobile/magazine/base.tpl \
	${context_dir}/app/views/mobile/magazine/category.tpl \
	${context_dir}/app/views/mobile/magazine/group.tpl \
	${context_dir}/app/views/mobile/magazine/index.tpl \
	${target_dir}/.htaccess \
	${context_dir}/.gitignore
)

### コピー実行
copyFromArray

### シンボリックリンク作成
ln_from=(\
	${script_dir}/common/css \
	${sdx_dir}/css \
	${script_dir}/common/img \
	${script_dir}/common/js \
	${sdx_dir}/js
	${script_dir}/application/controllers \
	${script_dir}/common/views \
	${sdx_dir}/views \
	${script_dir}/common/config \
	${sdx_dir}/config \
)

ln_to=(\
	${target_dir}/css/global \
	${target_dir}/css/sdx \
	${target_dir}/img/global \
	${target_dir}/js/global \
	${target_dir}/js/sdx
	${context_dir}/app/controllers \
	${context_dir}/app/views/global \
	${context_dir}/app/views/sdx \
	${context_dir}/config/global \
	${context_dir}/config/sdx \
)

### リンク作成
if [ "$force_symlink" = "TRUE" ]
then
	symlinkFromArrayForce
else
	symlinkFromArray
fi

### テキスト内に置換の必要なファイル群
replaceAndCopy ${sdx_dir}/copy/sunrise ${context_dir}/sunrise

if [ ! -x ${context_dir}/sunrise ]
then
	chmod 0777 ${context_dir}/sunrise
fi

replaceAndCopy ${script_dir}/copy/web/index.php ${target_dir}/index.php
replaceAndCopy ${script_dir}/copy/web/mobile_index.php ${target_dir}/mobile_index.php

### .gitkeep
touch ${target_dir}/css/i18n/.gitkeep
touch ${target_dir}/img/i18n/.gitkeep
touch ${target_dir}/js/i18n/.gitkeep

touch ${context_dir}/app/views/i18n/.gitkeep
touch ${context_dir}/cache/.gitkeep
touch ${context_dir}/config/i18n/.gitkeep
touch ${context_dir}/i18n/.gitkeep
touch ${context_dir}/log/.gitkeep
touch ${context_dir}/logs/.gitkeep
touch ${context_dir}/tmp/templates_c/.gitkeep

echo .gitkeep to some directories.